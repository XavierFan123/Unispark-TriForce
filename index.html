<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unispark 量化交易平台 - 实时加密货币与股票量化分析</title>
  <meta name="description" content="基于20日均线的专业量化交易平台，支持BTC、ETH、TQQQ实时分析与交易信号，数据来源自实时API。">
  <meta name="keywords" content="量化交易, API, 实时数据, BTC, ETH, TQQQ, 技术分析, 交易信号, 加密货币">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E₿%3C/text%3E%3C/svg%3E">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0a0a0a;
      background-image: 
        radial-gradient(ellipse at top, rgba(38, 32, 20, 0.4) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, rgba(20, 25, 35, 0.3) 0%, transparent 50%);
      min-height: 100vh;
      color: #E0E0E0;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .black-gold-card {
      background: rgba(10, 10, 10, 0.7);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 8px 32px rgba(212, 175, 55, 0.1);
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .black-gold-card:hover {
      transform: translateY(-8px);
      border-color: rgba(255, 215, 0, 0.6);
      box-shadow: 0 16px 40px rgba(212, 175, 55, 0.2);
    }

    .dynamic-gradient-text {
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% 200%;
      animation: gradient-shift 4s ease-in-out infinite;
    }

    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .status-indicator-glow::before {
      content: '';
      position: absolute;
      top: -5px; left: -5px; right: -5px; bottom: -5px;
      border-radius: 50%;
      background: inherit;
      z-index: -1;
      animation: pulse-glow 2.5s ease-in-out infinite;
      opacity: 0.5;
    }

    @keyframes pulse-glow {
      0%, 100% { transform: scale(0.8); opacity: 0.3; }
      50% { transform: scale(1.4); opacity: 0.1; }
    }

    .loading-spinner {
      border: 4px solid rgba(255, 215, 0, 0.2);
      border-top-color: #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .asset-tab {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .asset-tab.active {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(212, 175, 55, 0.1));
      border-color: rgba(255, 215, 0, 0.6) !important;
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.15);
    }

    .asset-tab:not(.active):hover {
      background: rgba(255, 215, 0, 0.08);
      border-color: rgba(255, 215, 0, 0.4) !important;
      transform: translateY(-2px);
    }

    .fade-in {
      animation: fadeIn 0.8s ease-out forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>

  <div id="root" class="max-w-7xl mx-auto p-4 md:p-6">
    <div class="black-gold-card rounded-3xl p-8 text-center">
      <div class="loading-spinner w-16 h-16 mx-auto mb-6"></div>
      <h2 class="text-2xl font-bold text-gray-200 mb-2">正在初始化量化系统...</h2>
      <p class="text-gray-400">请稍候，系统正在加载核心模块</p>
    </div>
  </div>

  <script>
    'use strict';
    
    class QuantState {
      constructor() {
        this.currentAsset = 'BTC';
        this.chartInstance = null;
        this.refreshInterval = null;
        this.isLoading = false;
        this.retryCount = 0;
        this.maxRetries = 3;
        // NOTE: The API key is exposed here. For a production app, this should be handled by a server.
        this.apiKey = 'cKlA3lVOMxMjg4hJsC0cn1YAIUu1Hk8P'; 
      }
      
      setAsset(asset) {
        if (this.currentAsset !== asset && this.assetConfigs[asset]) {
          this.currentAsset = asset;
          this.updateUrl(asset);
          return true;
        }
        return false;
      }
      
      updateUrl(asset) {
        const url = new URL(window.location);
        url.searchParams.set('asset', asset);
        window.history.pushState({}, '', url);
      }
      
      destroyChart() {
        if (this.chartInstance) {
          this.chartInstance.destroy();
          this.chartInstance = null;
        }
      }
      
      assetConfigs = {
        BTC: { name: 'Bitcoin', symbol: '₿', apiSymbol: 'BTCUSD', backupUrl: 'https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=90&interval=daily', color: '#FFD700', gradientColors: ['#FFD700', '#F0E68C', '#B8860B'], showSecondary: false, description: '全球最大的加密货币' },
        ETH: { name: 'Ethereum', symbol: 'Ξ', apiSymbol: 'ETHUSD', backupUrl: 'https://api.coingecko.com/api/v3/coins/ethereum/market_chart?vs_currency=usd&days=90&interval=daily', color: '#627EEA', gradientColors: ['#627EEA', '#8FA8F5', '#4A69D6'], showSecondary: false, description: '智能合约平台龙头' },
        TQQQ: { name: 'ProShares UltraPro QQQ', symbol: 'TQQQ', apiSymbol: 'TQQQ', indicatorSymbol: 'QQQ', color: '#00D4AA', gradientColors: ['#00D4AA', '#4DEBA8', '#00B894'], showSecondary: true, secondaryName: 'NASDAQ-100 (QQQ)', description: '纳斯达克指数三倍杠杆ETF' }
      };
    }

    const state = new QuantState();

    const utils = {
      formatNumber: (num, p=2) => num==null||isNaN(num)?'N/A':(Math.abs(num)>=1e9?(num/1e9).toFixed(p)+'B':(Math.abs(num)>=1e6?(num/1e6).toFixed(p)+'M':(Math.abs(num)>=1e3?(num/1e3).toFixed(p)+'K':num.toFixed(p)))),
      formatDate: date => date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }),
      formatPercentage: v => v==null||isNaN(v)?'N/A':`${v>0?'+':''}${v.toFixed(2)}%`,
    };

    const technicalAnalysis = {
      calculateIndicators:d=>d.map((r,i,a)=>{let M20=null,tr='未知';if(i>=19){const p=a.slice(i-19,i+1).map(x=>x.indicatorPrice);if(p.length===20&&p.every(n=>typeof n==='number')){M20=p.reduce((x,y)=>x+y,0)/20;const pM20=a[i-1].MA20;if(pM20)tr=M20>pM20?'上升':'下降'}}return{...r,MA20:M20,MAtrend:tr}}),
      generateSignals:d=>d.reduce((a,r,i)=>{let s='',p=i>0?a[i-1].POSITION:'空仓';if(i>=19&&r.MA20!=null&&r.MAtrend!=='未知'){const pr=r.indicatorPrice,m=r.MA20,t=r.MAtrend;if(p==='空仓'&&t==='上升'&&pr>m*1.01){s='买入';p='持有'}if(p==='持有'&&t==='下降'&&pr<m*0.99){s='卖出';p='空仓'}}a.push({...r,Signal:s,POSITION:p});return a},[]),
    };

    const ui = {
      renderAssetTabs:()=>`<div class="flex justify-center mb-8"><div class="flex bg-gray-900 bg-opacity-50 rounded-2xl p-2 space-x-2">${Object.keys(state.assetConfigs).map(a=>{const c=state.assetConfigs[a],i=a===state.currentAsset;return`<div class="asset-tab black-gold-card rounded-xl px-4 py-2 md:px-6 md:py-3 ${i?'active':''}" onclick="app.switchAsset('${a}')" style="border-color:${i?c.color+'80':'rgba(212,175,55,0.3)'}"><div class="flex items-center space-x-3"><span class="text-xl md:text-2xl">${c.symbol}</span><div><div class="font-semibold text-gray-200 text-sm md:text-base">${a}</div><div class="hidden md:block text-xs text-gray-400">${c.name}</div></div></div></div>`}).join('')}</div></div>`,
      renderMetricCard:(t,v,s,i,c,vc='')=>`<div class="black-gold-card rounded-2xl p-5"><div class="flex items-center justify-between mb-3"><h2 class="text-base font-semibold text-gray-300">${t}</h2><span class="text-2xl">${i}</span></div><p class="text-2xl md:text-3xl font-bold mb-1 ${vc}" style="color:${c};">${v}</p><p class="text-gray-500 text-xs md:text-sm">${s}</p></div>`,
      renderSignalList:s=>s.length?s.map(r=>`<div class="bg-gray-900 bg-opacity-50 rounded-xl p-3 flex justify-between items-center border border-gray-700 hover:border-amber-500 transition-colors duration-300"><span class="text-gray-400 text-sm">${utils.formatDate(r.date).substring(5)}</span><span class="px-3 py-1 rounded-full text-xs font-medium ${r.Signal==='买入'?'bg-green-500 bg-opacity-20 text-green-300':'bg-red-500 bg-opacity-20 text-red-300'}">${r.Signal}</span><span class="font-mono text-gray-200 font-bold">$${utils.formatNumber(r.price)}</span></div>`).join(''):`<div class="text-gray-500 text-center py-8">暂无近期交易信号</div>`,
    };

    const chartRenderer = {
      render(d,c){state.destroyChart();const x=document.getElementById('chart');if(!x)return;const a=d.slice(-90),ds=[{label:`${state.currentAsset}价格`,data:a.map(r=>r.price),borderColor:c.color,backgroundColor:c.color+'20',borderWidth:2,tension:0.4,fill:true,pointRadius:0},{label:'20日均线',data:a.map(r=>r.MA20),borderColor:'#E0E0E0',borderWidth:1.5,borderDash:[5,5],tension:0.4,fill:false,pointRadius:0},{label:'买入信号',data:a.map(r=>r.Signal==='买入'?r.price:null),pointStyle:'triangle',rotation:0,backgroundColor:'#28a745',borderColor:'#fff',borderWidth:1,pointRadius:8,pointHoverRadius:10,showLine:false},{label:'卖出信号',data:a.map(r=>r.Signal==='卖出'?r.price:null),pointStyle:'triangle',rotation:180,backgroundColor:'#dc3545',borderColor:'#fff',borderWidth:1,pointRadius:8,pointHoverRadius:10,showLine:false}];if(state.currentAsset==='TQQQ')ds.splice(1,0,{label:'QQQ价格',data:a.map(r=>r.secondaryPrice),borderColor:'#9CA3AF',borderWidth:1.5,tension:0.4,fill:false,pointRadius:0,yAxisID:'y1'});const o={responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{color:'#E0E0E0',font:{size:12},usePointStyle:true,padding:20}},tooltip:{mode:'index',intersect:false,backgroundColor:'rgba(0,0,0,0.9)',titleColor:c.color,bodyColor:'#E0E0E0',borderColor:c.color+'80',borderWidth:1,cornerRadius:8,callbacks:{label:ctx=>`${ctx.dataset.label}: $${utils.formatNumber(ctx.parsed.y)}`}}},scales:{x:{ticks:{color:'#888',font:{size:10}},grid:{color:c.color+'10'}},y:{position:'right',ticks:{callback:v=>'$'+utils.formatNumber(v),color:'#888',font:{size:10}},grid:{color:c.color+'20',drawBorder:false}}},interaction:{mode:'nearest',axis:'x',intersect:false}};if(state.currentAsset==='TQQQ')o.scales.y1={type:'linear',display:false,position:'left'};state.chartInstance=new Chart(x.getContext('2d'),{type:'line',data:{labels:a.map(r=>utils.formatDate(r.date).substring(5)),datasets:ds},options:o})},
    };
    
    class QuantApp {
      constructor() { this.init(); }

      init() {
        this.initializeFromUrl();
        this.setupEventListeners();
        this.renderDashboard();
      }

      initializeFromUrl() {
        const urlAsset = new URLSearchParams(window.location.search).get('asset');
        if (urlAsset && state.assetConfigs[urlAsset.toUpperCase()]) {
          state.currentAsset = urlAsset.toUpperCase();
        }
      }

      setupEventListeners() {
        window.addEventListener('popstate', () => { this.initializeFromUrl(); this.renderDashboard(); });
        document.addEventListener('visibilitychange', () => { document.hidden ? this.pauseAutoRefresh() : this.resumeAutoRefresh(); });
      }

      setupAutoRefresh() {
        this.pauseAutoRefresh();
        state.refreshInterval = setInterval(() => { if (!document.hidden && !state.isLoading) this.renderDashboard(); }, 5 * 60 * 1000);
      }
      pauseAutoRefresh() { if(state.refreshInterval) clearInterval(state.refreshInterval); state.refreshInterval = null; }
      resumeAutoRefresh() { if(!state.refreshInterval) this.setupAutoRefresh(); }

      switchAsset(asset) { if (state.setAsset(asset)) this.renderDashboard(); }
      
      // --- Live API Data Fetching Logic ---
      async _fetchJson(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Request failed: ${response.status}`);
        const data = await response.json();
        // Handle CORS proxy structure
        if (data.contents) return JSON.parse(data.contents);
        return data;
      }

      async _loadBackupData(asset) {
        console.warn(`Falling back to CoinGecko for ${asset}`);
        const config = state.assetConfigs[asset];
        if (!config.backupUrl) throw new Error("No backup URL configured.");
        
        const data = await this._fetchJson(config.backupUrl);
        return data.prices.map(item => ({
            date: new Date(item[0]),
            price: parseFloat(item[1]),
            indicatorPrice: parseFloat(item[1])
        }));
      }

      async _loadTQQQData(proxy) {
        const tqqqUrl = `https://financialmodelingprep.com/api/v3/historical-price-full/TQQQ?timeseries=90&apikey=${state.apiKey}`;
        const qqqUrl = `https://financialmodelingprep.com/api/v3/historical-price-full/QQQ?timeseries=90&apikey=${state.apiKey}`;

        const [tqqqData, qqqData] = await Promise.all([
          this._fetchJson(proxy + encodeURIComponent(tqqqUrl)),
          this._fetchJson(proxy + encodeURIComponent(qqqUrl))
        ]);

        const qqqMap = new Map(qqqData.historical.map(item => [item.date, item.close]));

        return tqqqData.historical
          .map(item => {
            const qqqPrice = qqqMap.get(item.date);
            if (!qqqPrice) return null;
            return {
              date: new Date(item.date),
              price: parseFloat(item.close),
              indicatorPrice: parseFloat(qqqPrice),
              secondaryPrice: parseFloat(qqqPrice)
            };
          })
          .filter(Boolean)
          .reverse();
      }

      async loadAssetData(asset) {
        const config = state.assetConfigs[asset];
        const corsProxy = 'https://api.allorigins.win/get?url=';
        
        try {
          if (asset === 'TQQQ') {
            return await this._loadTQQQData(corsProxy);
          }
          
          const apiUrl = `https://financialmodelingprep.com/api/v3/historical-price-full/${config.apiSymbol}?timeseries=90&apikey=${state.apiKey}`;
          const data = await this._fetchJson(corsProxy + encodeURIComponent(apiUrl));
          
          if (!data.historical || data.historical.length === 0) {
              throw new Error("Primary API returned no historical data.");
          }

          return data.historical
            .map(item => ({
              date: new Date(item.date),
              price: parseFloat(item.close),
              indicatorPrice: parseFloat(item.close)
            }))
            .reverse();

        } catch (err) {
          console.error(`Primary API failed for ${asset}:`, err);
          return await this._loadBackupData(asset);
        }
      }

      async renderDashboard() {
        if (state.isLoading) return;
        state.isLoading = true;
        
        const root = document.getElementById('root');
        root.innerHTML = `<div class="fade-in">${ui.renderAssetTabs()}<div class="black-gold-card rounded-3xl p-8 text-center"><div class="loading-spinner w-12 h-12 mx-auto mb-6"></div><h2 class="text-xl font-bold text-gray-200 mb-2">正在从实时API加载 ${state.currentAsset} 数据...</h2><p class="text-gray-400 text-sm">请稍候</p></div></div>`;
        
        try {
          const rawData = await this.loadAssetData(state.currentAsset);
          if (rawData.length < 20) throw new Error(`数据不足以分析: 需要至少20天数据，实际获取${rawData.length}天`);

          const dataWithMA = technicalAnalysis.calculateIndicators(rawData);
          const dataWithSignals = technicalAnalysis.generateSignals(dataWithMA);
          const latest = dataWithSignals[dataWithSignals.length-1], prev = dataWithSignals[dataWithSignals.length-2];
          const priceChange = prev ? (latest.price - prev.price) / prev.price * 100 : 0;
          const config = state.assetConfigs[state.currentAsset];
          const gradientStyle = `background:linear-gradient(120deg,${config.gradientColors[0]} 20%,${config.gradientColors[1]} 50%,${config.gradientColors[2]} 90%);`;

          root.innerHTML = `<div class="fade-in">${ui.renderAssetTabs()}<div class="black-gold-card rounded-3xl p-4 md:p-8 mb-6"><div class="text-center mb-10"><h1 class="text-4xl md:text-5xl font-extrabold mb-4 flex items-center justify-center tracking-wider dynamic-gradient-text" style="${gradientStyle}"><span class="text-5xl md:text-6xl mr-4 opacity-80">${config.symbol}</span> ${state.currentAsset} Unispark 量化 <div class="status-indicator-glow relative ml-4 mt-1"><div class="w-3 h-3 rounded-full" style="background-color:${config.color}"></div></div></h1><p class="text-gray-400 text-base md:text-lg">${config.description} | 基于20日均线分析</p>${state.currentAsset==='TQQQ'?`<p class="text-amber-400 text-sm mt-2 bg-amber-900 bg-opacity-30 px-3 py-1 rounded-full inline-block">⚠️ 交易标的: TQQQ | 指标基准: QQQ</p>`:''}</div><div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">${ui.renderMetricCard('🎯 交易建议',latest.POSITION,'综合技术指标研判',latest.POSITION==='持有'?'🟢':'🔴',latest.POSITION==='持有'?'#22c55e':'#ef4444')} ${ui.renderMetricCard(`💰 ${state.currentAsset}价格`,`$${utils.formatNumber(latest.price)}`,`24h: ${utils.formatPercentage(priceChange)} ${config.showSecondary?`| QQQ: $${utils.formatNumber(latest.secondaryPrice)}`:''}`,'💎',config.color)} ${ui.renderMetricCard('📈 20日均线',`$${utils.formatNumber(latest.MA20)}`,`趋势: ${latest.MAtrend} | ${latest.indicatorPrice>latest.MA20?'高于均线':'低于均线'}`,latest.MAtrend==='上升'?'🚀':'📉','#E0E0E0')} ${ui.renderMetricCard('📊 信号统计',`${dataWithSignals.filter(r=>r.Signal).length}`,`买入: ${dataWithSignals.filter(r=>r.Signal==='买入').length} | 卖出: ${dataWithSignals.filter(r=>r.Signal==='卖出').length}`,'🔔','#a78bfa')}</div><div class="grid lg:grid-cols-5 gap-4 md:gap-6 mb-8"><div class="lg:col-span-3 black-gold-card rounded-2xl p-4 md:p-6"><h2 class="text-xl font-semibold text-gray-200 mb-4 flex items-center"><span class="mr-3" style="color:${config.color}">📈</span>价格走势与信号</h2><div class="bg-black bg-opacity-25 rounded-xl p-2 md:p-4"><canvas id="chart" height="280"></canvas></div></div><div class="lg:col-span-2 black-gold-card rounded-2xl p-4 md:p-6"><h2 class="text-xl font-semibold text-gray-200 mb-4 flex items-center"><span class="mr-3" style="color:${config.color}">🔍</span>最近交易信号</h2><div class="space-y-3 max-h-[280px] overflow-y-auto pr-2">${ui.renderSignalList(dataWithSignals.filter(r=>r.Signal).slice(-5).reverse())}</div></div></div><div class="text-center mt-8 pt-6 border-t border-gray-700 border-opacity-50"><p class="text-gray-500 text-sm mb-2">⚠️ 本分析仅供参考，投资有风险，决策需谨慎。</p><p class="text-gray-600 text-xs">数据来源: financialmodelingprep.com & coingecko.com | 最后更新: ${new Date().toLocaleString('zh-CN')}</p></div></div></div>`;
          
          setTimeout(() => chartRenderer.render(dataWithSignals, config), 100);
          state.retryCount = 0;
          this.setupAutoRefresh();

        } catch (error) {
          console.error('Dashboard Render Failed:', error);
          if (state.retryCount < state.maxRetries) {
            state.retryCount++;
            setTimeout(() => this.renderDashboard(), 3000 * state.retryCount);
          } else {
            root.innerHTML = `<div class="fade-in">${ui.renderAssetTabs()}<div class="black-gold-card rounded-3xl p-8 text-center"><div class="text-6xl mb-4 text-red-400">❌</div><h2 class="text-2xl font-bold text-gray-200 mb-4">系统加载失败</h2><p class="text-gray-400">${error.message}</p><button onclick="location.reload()" class="mt-6 black-gold-card px-6 py-3 rounded-xl hover:scale-105 transition-transform">重新加载</button></div></div>`;
          }
        } finally {
          state.isLoading = false;
        }
      }
    }

    let app;
    document.addEventListener('DOMContentLoaded', () => { app = new QuantApp(); });
    window.addEventListener('beforeunload', () => { if (app) app.pauseAutoRefresh(); state.destroyChart(); });

  </script>

</body>
</html>
