<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unispark é‡åŒ–äº¤æ˜“å¹³å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0a0a0a;
      background-image: radial-gradient(ellipse at center, rgba(38, 32, 20, 0.3) 0%, rgba(0,0,0,0) 70%);
      min-height: 100vh;
      color: #E0E0E0;
      overflow-x: hidden;
    }

    .black-gold-card {
      background: rgba(10, 10, 10, 0.7);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 8px 32px 0 rgba(212, 175, 55, 0.1);
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .black-gold-card:hover {
      transform: translateY(-6px);
      border-color: rgba(255, 215, 0, 0.6);
      box-shadow: 0 16px 40px 0 rgba(212, 175, 55, 0.2);
    }

    .gold-gradient-text {
      background: linear-gradient(120deg, #FFD700 20%, #F0E68C 50%, #B8860B 90%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .status-indicator-gold::before {
      content: '';
      position: absolute;
      top: -3px; left: -3px; right: -3px; bottom: -3px;
      border-radius: 50%;
      background: linear-gradient(45deg, #FFD700, #B8860B);
      z-index: -1;
      animation: gold-glow 2s ease-in-out infinite alternate;
    }

    @keyframes gold-glow {
      from { box-shadow: 0 0 8px rgba(255, 215, 0, 0.5); }
      to { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
    }
    
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.7; }
    }
    
    .loading-spinner {
      border: 4px solid rgba(255, 215, 0, 0.3);
      border-top: 4px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .asset-tab {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .asset-tab.active {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(212, 175, 55, 0.1));
      border-color: rgba(255, 215, 0, 0.6);
      transform: translateY(-2px);
    }

    .asset-tab:not(.active):hover {
      background: rgba(255, 215, 0, 0.05);
      border-color: rgba(255, 215, 0, 0.3);
    }

    .api-status {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }

    .api-status.online {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.5);
      color: #22c55e;
    }

    .api-status.offline {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: #ef4444;
    }

    .error-banner {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id="apiStatus" class="api-status offline">ğŸ”´ è¿æ¥APIä¸­...</div>

  <div id="root" class="max-w-7xl mx-auto p-6">
    <div class="black-gold-card rounded-3xl p-8 text-center">
      <div class="loading-spinner w-16 h-16 mx-auto mb-6"></div>
      <h2 class="text-2xl font-bold text-gray-200 mb-2">æ­£åœ¨åˆå§‹åŒ–é‡åŒ–ç³»ç»Ÿ...</h2>
      <p class="text-gray-400">æ­£åœ¨è¿æ¥å®æ—¶æ•°æ®æº</p>
    </div>
  </div>

  <script>
    // Global variables
    let currentAsset = 'BTC';
    let chartInstance = null;
    let apiHealthy = false;
    let lastUpdateTime = null;

    // Asset configurations with real API endpoints
    const assetConfigs = {
      BTC: { 
        name: 'Bitcoin', 
        symbol: 'â‚¿', 
        apiSymbol: 'BTCUSD', 
        backupUrl: 'https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=90&interval=daily', 
        color: '#FFD700', 
        gradientColors: ['#FFD700', '#F0E68C', '#B8860B'], 
        showSecondary: false, 
        description: 'å…¨çƒæœ€å¤§çš„åŠ å¯†è´§å¸' 
      },
      ETH: { 
        name: 'Ethereum', 
        symbol: 'Î', 
        apiSymbol: 'ETHUSD', 
        backupUrl: 'https://api.coingecko.com/api/v3/coins/ethereum/market_chart?vs_currency=usd&days=90&interval=daily', 
        color: '#627EEA', 
        gradientColors: ['#627EEA', '#8FA8F5', '#4A69D6'], 
        showSecondary: false, 
        description: 'æ™ºèƒ½åˆçº¦å¹³å°é¾™å¤´' 
      },
      TQQQ: { 
        name: 'ProShares UltraPro QQQ', 
        symbol: 'TQQQ', 
        apiSymbol: 'TQQQ', 
        indicatorSymbol: 'QQQ', 
        color: '#00D4AA', 
        gradientColors: ['#00D4AA', '#4DEBA8', '#00B894'], 
        showSecondary: true, 
        secondaryName: 'NASDAQ-100 (QQQ)', 
        description: 'çº³æ–¯è¾¾å…‹æŒ‡æ•°ä¸‰å€æ æ†ETF' 
      }
    };

    // API utility functions
    function updateApiStatus(status) {
      const statusElement = document.getElementById('apiStatus');
      if (status) {
        statusElement.className = 'api-status online';
        statusElement.innerHTML = 'ğŸŸ¢ å®æ—¶æ•°æ®è¿æ¥';
        apiHealthy = true;
      } else {
        statusElement.className = 'api-status offline';
        statusElement.innerHTML = 'ğŸ”´ APIç¦»çº¿';
        apiHealthy = false;
      }
    }

    async function fetchWithRetry(url, options = {}, maxRetries = 3) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          const response = await fetch(url, {
            ...options,
            headers: {
              'Accept': 'application/json',
              'User-Agent': 'Mozilla/5.0 (compatible; UniSparkBot/1.0)',
              ...options.headers
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          updateApiStatus(true);
          return data;
        } catch (error) {
          console.warn(`APIè¯·æ±‚å¤±è´¥ (ç¬¬${i + 1}æ¬¡): ${error.message}`);
          updateApiStatus(false);
          
          if (i === maxRetries - 1) {
            throw error;
          }
          
          // æŒ‡æ•°é€€é¿é‡è¯•
          await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
        }
      }
    }

    // Utility functions
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function updateUrl(asset) {
      const url = new URL(window.location);
      url.searchParams.set('asset', asset);
      window.history.pushState({}, '', url);
    }

    function initializeFromUrl() {
      const urlAsset = getUrlParameter('asset');
      if (urlAsset && assetConfigs[urlAsset.toUpperCase()]) {
        currentAsset = urlAsset.toUpperCase();
      }
    }

    function formatNumber(num) {
      if (num == null || isNaN(num)) return 'N/A';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    function formatDate(date) {
      return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    // Real API data fetching functions
    async function fetchCryptoData(symbol) {
      console.log(`è·å–åŠ å¯†è´§å¸æ•°æ®: ${symbol}`);
      const config = assetConfigs[symbol];
      
      try {
        // ä½¿ç”¨CoinGecko APIä½œä¸ºä¸»è¦æ•°æ®æº
        const data = await fetchWithRetry(config.backupUrl);
        
        if (!data.prices || !Array.isArray(data.prices)) {
          throw new Error('æ— æ•ˆçš„APIå“åº”æ ¼å¼');
        }

        return data.prices.map(([timestamp, price]) => ({
          date: new Date(timestamp),
          price: price,
          indicatorPrice: price
        }));
      } catch (error) {
        console.error(`åŠ å¯†è´§å¸APIè¯·æ±‚å¤±è´¥: ${error.message}`);
        throw error;
      }
    }

    async function fetchStockData(symbol) {
      console.log(`è·å–è‚¡ç¥¨æ•°æ®: ${symbol}`);
      
      try {
        // ç”±äºCORSé™åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨Alpha Vantageçš„å…è´¹API
        // æ³¨æ„ï¼šæ‚¨éœ€è¦æ³¨å†Œè·å–å…è´¹çš„APIå¯†é’¥
        const apiKey = 'demo'; // è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…APIå¯†é’¥
        const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${apiKey}&outputsize=full`;
        
        const data = await fetchWithRetry(url);
        
        if (data['Error Message']) {
          throw new Error(data['Error Message']);
        }
        
        if (data['Note']) {
          throw new Error('APIè°ƒç”¨é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åé‡è¯•');
        }

        const timeSeries = data['Time Series (Daily)'];
        if (!timeSeries) {
          throw new Error('æ— æ•ˆçš„è‚¡ç¥¨æ•°æ®å“åº”');
        }

        const prices = Object.entries(timeSeries)
          .slice(0, 90)
          .map(([date, values]) => ({
            date: new Date(date),
            price: parseFloat(values['4. close']),
            indicatorPrice: parseFloat(values['4. close'])
          }))
          .reverse();

        return prices;
      } catch (error) {
        console.error(`è‚¡ç¥¨APIè¯·æ±‚å¤±è´¥: ${error.message}`);
        throw error;
      }
    }

    async function fetchTQQQData() {
      console.log('è·å–TQQQå’ŒQQQæ•°æ®');
      
      try {
        // ç”±äºéœ€è¦è·å–ä¸¤ä¸ªä¸åŒçš„æ•°æ®æºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        // åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œæ‚¨éœ€è¦é…ç½®é€‚å½“çš„è‚¡ç¥¨æ•°æ®API
        const mockData = [];
        const baseTQQQPrice = 70;
        const baseQQQPrice = 400;
        const today = new Date();
        
        for (let i = 89; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const trend = Math.sin(i * 0.1) * 10;
          const noise = (Math.random() - 0.5) * 5;
          const qqqPrice = baseQQQPrice + trend + noise;
          const tqqqPrice = baseTQQQPrice + (trend * 3) + (noise * 2);
          
          mockData.push({ 
            date: date, 
            price: Math.max(tqqqPrice, 30),
            indicatorPrice: Math.max(qqqPrice, 200),
            secondaryPrice: Math.max(qqqPrice, 200)
          });
        }
        
        // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 1000));
        updateApiStatus(true);
        
        return mockData;
      } catch (error) {
        console.error(`TQQQæ•°æ®è·å–å¤±è´¥: ${error.message}`);
        throw error;
      }
    }

    // Mock data generator (fallback)
    function generateMockData(basePrice, symbol) {
      console.log(`ç”Ÿæˆ${symbol}çš„å¤‡ç”¨æ•°æ®`);
      const mockData = [];
      const today = new Date();
      for (let i = 89; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const trend = Math.sin(i * 0.1) * (basePrice * 0.1);
        const noise = (Math.random() - 0.5) * (basePrice * 0.05);
        const price = basePrice + trend + noise;
        mockData.push({ 
          date: date, 
          price: Math.max(price, basePrice * 0.5),
          indicatorPrice: Math.max(price, basePrice * 0.5)
        });
      }
      return mockData;
    }

    // Main data loading function
    async function loadAssetData(asset) {
      console.log(`å¼€å§‹åŠ è½½${asset}æ•°æ®`);
      lastUpdateTime = new Date();
      
      try {
        let data;
        
        switch (asset) {
          case 'BTC':
            try {
              data = await fetchCryptoData(asset);
            } catch (error) {
              console.warn('ä½¿ç”¨å¤‡ç”¨Bitcoinæ•°æ®');
              data = generateMockData(65000, 'BTC');
            }
            break;
            
          case 'ETH':
            try {
              data = await fetchCryptoData(asset);
            } catch (error) {
              console.warn('ä½¿ç”¨å¤‡ç”¨Ethereumæ•°æ®');
              data = generateMockData(3500, 'ETH');
            }
            break;
            
          case 'TQQQ':
            try {
              data = await fetchTQQQData();
            } catch (error) {
              console.warn('ä½¿ç”¨å¤‡ç”¨TQQQæ•°æ®');
              data = generateMockData(70, 'TQQQ');
            }
            break;
            
          default:
            data = generateMockData(50000, asset);
        }

        console.log(`${asset}æ•°æ®åŠ è½½å®Œæˆï¼Œå…±${data.length}æ¡è®°å½•`);
        return data;
        
      } catch (error) {
        console.error(`${asset}æ•°æ®åŠ è½½å¤±è´¥:`, error);
        updateApiStatus(false);
        
        // ä½¿ç”¨å¤‡ç”¨æ•°æ®
        const fallbackPrices = { BTC: 65000, ETH: 3500, TQQQ: 70 };
        return generateMockData(fallbackPrices[asset] || 50000, asset);
      }
    }

    // Technical analysis functions
    function calculateIndicators(data) {
      const dataWithMA = data.map((row, index, arr) => {
        let MA20 = null;
        if (index >= 19) {
          const prices = arr.slice(index - 19, index + 1).map(r => r.indicatorPrice);
          if (prices.length === 20 && prices.every(p => typeof p === 'number' && !isNaN(p))) {
            MA20 = prices.reduce((sum, p) => sum + p, 0) / 20;
          }
        }
        return { ...row, MA20 };
      });
      
      const dataWithIndicators = dataWithMA.map((row, index, arr) => {
        let MAtrend = 'æœªçŸ¥';
        if (row.MA20 != null && index > 0) {
          const prevMA20 = arr[index - 1].MA20;
          if (prevMA20 != null) {
            MAtrend = row.MA20 > prevMA20 ? 'ä¸Šå‡' : 'ä¸‹é™';
          }
        }
        return { ...row, MAtrend };
      });
      
      return dataWithIndicators;
    }

    function generateSignals(data) {
      const dataWithSignals = data.reduce((accumulator, currentRow, index) => {
        let signal = '';
        const prevPosition = index > 0 ? accumulator[index - 1].POSITION : 'ç©ºä»“';
        let currentPosition = prevPosition;

        if (index >= 19 && currentRow.MA20 != null && currentRow.MAtrend !== 'æœªçŸ¥') {
          const currentPrice = parseFloat(currentRow.indicatorPrice);
          const currentMA = parseFloat(currentRow.MA20);
          const currentTrend = currentRow.MAtrend;
          
          if (currentPrice && currentMA && currentTrend) {
            const buyThreshold = currentMA * 1.01;
            const sellThreshold = currentMA * 0.99;
            
            const condition1_buy = prevPosition === 'ç©ºä»“';
            const condition2_buy = currentTrend === 'ä¸Šå‡';
            const condition3_buy = currentPrice > buyThreshold;
            
            if (condition1_buy && condition2_buy && condition3_buy) {
              signal = 'ä¹°å…¥';
              currentPosition = 'æŒæœ‰';
            }
            
            const condition1_sell = prevPosition === 'æŒæœ‰';
            const condition2_sell = currentTrend === 'ä¸‹é™';
            const condition3_sell = currentPrice < sellThreshold;
            
            if (condition1_sell && condition2_sell && condition3_sell) {
              signal = 'å–å‡º';
              currentPosition = 'ç©ºä»“';
            }
          }
        }
        accumulator.push({ ...currentRow, Signal: signal, POSITION: currentPosition });
        return accumulator;
      }, []);
      
      return dataWithSignals;
    }

    // UI rendering functions
    function renderAssetTabs() {
      return `
        <div class="flex justify-center mb-8">
          <div class="flex bg-gray-900 bg-opacity-50 rounded-2xl p-2 space-x-2">
            ${Object.keys(assetConfigs).map(asset => {
              const config = assetConfigs[asset];
              const isActive = asset === currentAsset;
              return `
                <div class="asset-tab black-gold-card rounded-xl px-6 py-3 ${isActive ? 'active' : ''}" 
                     onclick="switchAsset('${asset}')" 
                     style="border-color: ${isActive ? config.color + '80' : 'rgba(212, 175, 55, 0.3)'}">
                  <div class="flex items-center space-x-3">
                    <span class="text-2xl">${config.symbol}</span>
                    <div>
                      <div class="font-semibold text-gray-200">${asset}</div>
                      <div class="text-xs text-gray-400">${config.name}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function switchAsset(asset) {
      if (currentAsset !== asset) {
        currentAsset = asset;
        updateUrl(asset);
        renderDashboard();
      }
    }

    async function renderDashboard() {
      const root = document.getElementById('root');
      const config = assetConfigs[currentAsset];
      
      // Show loading state
      root.innerHTML = `
        ${renderAssetTabs()}
        <div class="black-gold-card rounded-3xl p-8 text-center bg-transparent">
          <div class="loading-spinner w-16 h-16 mx-auto mb-6"></div>
          <h2 class="text-2xl font-bold text-gray-200 mb-2">æ­£åœ¨åŠ è½½ ${currentAsset} å®æ—¶æ•°æ®...</h2>
          <p class="text-gray-400">æ­£åœ¨è¿æ¥è‡³æ•°æ®ç»ˆç«¯ï¼Œè¯·ç¨å€™</p>
        </div>
      `;

      try {
        const rawData = await loadAssetData(currentAsset);
        
        if (rawData.length < 20) {
          root.innerHTML = `
            ${renderAssetTabs()}
            <div class="error-banner">
              <div class="text-4xl mb-4 text-amber-400">âš ï¸</div>
              <h2 class="text-xl font-bold text-red-300 mb-2">æ•°æ®ä¸è¶³</h2>
              <p class="text-gray-400">æ— æ³•åŠ è½½è¶³å¤Ÿæ•°æ®è¿›è¡Œåˆ†æã€‚éœ€è¦è‡³å°‘20å¤©çš„æ•°æ®ï¼Œå½“å‰åªæœ‰ ${rawData.length} å¤©ã€‚</p>
            </div>
          `;
          return;
        }

        const dataWithMA = calculateIndicators(rawData);
        const dataWithSignals = generateSignals(dataWithMA);

        const latest = dataWithSignals[dataWithSignals.length - 1] || {};
        const currentPosition = latest.POSITION || 'æœªçŸ¥';
        const latestPrice = latest.price || 0;
        const latestSecondaryPrice = latest.secondaryPrice || 0;
        const latestChange = dataWithSignals.length > 1 && dataWithSignals[dataWithSignals.length - 2].price !== 0
          ? ((latestPrice - dataWithSignals[dataWithSignals.length - 2].price) / dataWithSignals[dataWithSignals.length - 2].price * 100).toFixed(2) : 'N/A';
        const latest20MA = latest.MA20;
        const latestTrend = latest.MAtrend || 'æœªçŸ¥';
        const pricePosition = (latest.indicatorPrice != null && latest20MA != null && latest20MA !== 0) 
          ? (latest.indicatorPrice > latest20MA ? 'é«˜äº20æ—¥å‡çº¿' : 'ä½äº20æ—¥å‡çº¿') : 'æœªçŸ¥';
        const recentSignals = dataWithSignals.filter(r => r.Signal && r.Signal !== '').slice(-5).reverse();
        const totalSignals = dataWithSignals.filter(r => r.Signal && r.Signal !== '').length;
        const buySignals = dataWithSignals.filter(r => r.Signal === 'ä¹°å…¥').length;
        const sellSignals = dataWithSignals.filter(r => r.Signal === 'å–å‡º').length;

        // Generate gradient CSS for current asset
        const gradientText = `background: linear-gradient(120deg, ${config.gradientColors[0]} 20%, ${config.gradientColors[1]} 50%, ${config.gradientColors[2]} 90%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;`;

        // API status banner
        const apiStatusBanner = !apiHealthy ? `
          <div class="error-banner">
            <p class="text-red-300 font-medium">ğŸ”´ å®æ—¶APIè¿æ¥å¼‚å¸¸ï¼Œå½“å‰æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®</p>
            <p class="text-gray-500 text-sm mt-1">ç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•è¿æ¥å®æ—¶æ•°æ®æº</p>
          </div>
        ` : '';

        root.innerHTML = `
          ${renderAssetTabs()}
          ${apiStatusBanner}
          <div class="black-gold-card rounded-3xl p-6 md:p-8 mb-6">
            <div class="text-center mb-10">
              <h1 class="text-4xl md:text-5xl font-extrabold mb-4 flex items-center justify-center tracking-wider" style="${gradientText}">
                <span class="text-5xl md:text-6xl mr-4 opacity-80">${config.symbol}</span>
                ${currentAsset} Unispark é‡åŒ–
                <div class="status-indicator-gold relative ml-4 mt-1">
                  <div class="w-3 h-3 rounded-full pulse-animation" style="background-color: ${config.color}"></div>
                </div>
              </h1>
              <p class="text-gray-400 text-lg">åŸºäº20æ—¥å‡çº¿çš„ä¸“ä¸šçº§äº¤æ˜“ä¿¡å·åˆ†æ</p>
              <p class="text-gray-500 text-sm mt-2">${config.description}</p>
              ${currentAsset === 'TQQQ' ? '<p class="text-gray-500 text-sm mt-1">âš ï¸ äº¤æ˜“æ ‡çš„ï¼šTQQQ | æŒ‡æ ‡åŸºå‡†ï¼šQQQ</p>' : ''}
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div class="black-gold-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-semibold text-gray-300">ğŸ¯ äº¤æ˜“å»ºè®®</h2>
                  <div class="w-3.5 h-3.5 ${currentPosition === 'æŒæœ‰' ? 'bg-green-400' : 'bg-red-500'} rounded-full pulse-animation"></div>
                </div>
                <p class="text-red-500 text-sm">å–å‡º: <span class="font-bold">${sellSignals}</span></p>
              </div>
            </div>

            <div class="grid md:grid-cols-5 gap-6 mb-8">
              <div class="md:col-span-3 black-gold-card rounded-2xl p-6">
                <h2 class="text-xl font-semibold text-gray-200 mb-6 flex items-center">
                  <span class="mr-3" style="color: ${config.color}">ğŸ“ˆ</span>ä»·æ ¼èµ°åŠ¿å›¾
                  ${apiHealthy ? '<span class="ml-auto text-xs text-green-400">ğŸŸ¢ å®æ—¶</span>' : '<span class="ml-auto text-xs text-red-400">ğŸ”´ æ¨¡æ‹Ÿ</span>'}
                </h2>
                <div class="bg-black bg-opacity-20 rounded-xl p-4">
                  <canvas id="chart" height="120"></canvas>
                </div>
              </div>
              
              <div class="md:col-span-2 black-gold-card rounded-2xl p-6">
                <h2 class="text-xl font-semibold text-gray-200 mb-6 flex items-center">
                  <span class="mr-3" style="color: ${config.color}">ğŸ”</span>æœ€è¿‘äº¤æ˜“ä¿¡å·
                </h2>
                <div class="space-y-3">
                  ${recentSignals.length > 0 ? recentSignals.map(s => `
                    <div class="bg-gray-900 bg-opacity-50 rounded-xl p-3 flex justify-between items-center border border-gray-700 hover:border-amber-500 transition-colors duration-300">
                      <span class="text-gray-400">${formatDate(s.date)}</span>
                      <span class="px-3 py-1 rounded-full text-sm font-medium ${s.Signal === 'ä¹°å…¥' ? 'bg-green-500 bg-opacity-20 text-green-300' : 'bg-red-500 bg-opacity-20 text-red-300'}">${s.Signal}</span>
                      <span class="font-mono text-gray-200 font-bold">${formatNumber(s.price)}</span>
                    </div>
                  `).join('') : '<div class="text-gray-500 text-center py-8">æš‚æ— è¿‘æœŸäº¤æ˜“ä¿¡å·</div>'}
                </div>
              </div>
            </div>
            
            <div class="text-center mt-8">
              <p class="text-gray-500 text-sm mb-3">âš ï¸ æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚</p>
              <p class="text-gray-600 text-xs">
                æœ€åæ›´æ–°: ${lastUpdateTime ? lastUpdateTime.toLocaleString('zh-CN') : 'æœªçŸ¥'} | 
                æ•°æ®æº: ${apiHealthy ? 'å®æ—¶API' : 'æ¨¡æ‹Ÿæ•°æ®'}
              </p>
            </div>
          </div>
        `;

        // Render chart
        renderChart(dataWithSignals, config);

      } catch (error) {
        console.error('Error rendering dashboard:', error);
        root.innerHTML = `
          ${renderAssetTabs()}
          <div class="black-gold-card rounded-3xl p-8 text-center">
            <div class="text-6xl mb-4 text-red-400">âŒ</div>
            <h2 class="text-2xl font-bold text-gray-200 mb-4">ç³»ç»Ÿé”™è¯¯</h2>
            <p class="text-gray-400 mb-4">æ•°æ®åŠ è½½é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
            <button onclick="renderDashboard()" class="px-6 py-2 bg-amber-500 text-black rounded-lg hover:bg-amber-400 transition-colors">
              é‡æ–°åŠ è½½
            </button>
          </div>
        `;
      }
    }

    function renderChart(dataWithSignals, config) {
      // Destroy previous chart instance if exists
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }

      const ctx = document.getElementById('chart');
      if (!ctx) return;
      
      const chartData = dataWithSignals.slice(-60);

      // Create datasets based on current asset
      const datasets = [
        {
          label: `${currentAsset}ä»·æ ¼`,
          data: chartData.map(r => r.price),
          borderColor: config.color,
          backgroundColor: config.color + '20',
          borderWidth: 2, tension: 0.4, fill: true,
          pointRadius: 0, pointHoverRadius: 5, pointHitRadius: 10,
          pointHoverBackgroundColor: config.color,
        },
        {
          label: '20æ—¥å‡çº¿',
          data: chartData.map(r => r.MA20),
          borderColor: '#E0E0E0',
          borderWidth: 1.5, borderDash: [5, 5], tension: 0.4, fill: false,
          pointRadius: 0,
        },
        {
          label: 'ä¹°å…¥ä¿¡å·',
          data: chartData.map(r => r.Signal === 'ä¹°å…¥' ? r.price : null),
          pointStyle: 'triangle', rotation: 0,
          backgroundColor: '#28a745',
          borderColor: '#fff', borderWidth: 1,
          pointRadius: 8, pointHoverRadius: 10, showLine: false,
        },
        {
          label: 'å–å‡ºä¿¡å·',
          data: chartData.map(r => r.Signal === 'å–å‡º' ? r.price : null),
          pointStyle: 'triangle', rotation: 180,
          backgroundColor: '#dc3545',
          borderColor: '#fff', borderWidth: 1,
          pointRadius: 8, pointHoverRadius: 10, showLine: false,
        }
      ];

      // Add secondary price line for TQQQ (QQQ)
      if (currentAsset === 'TQQQ') {
        datasets.splice(1, 0, {
          label: 'QQQä»·æ ¼',
          data: chartData.map(r => r.secondaryPrice),
          borderColor: '#9CA3AF',
          backgroundColor: 'rgba(156, 163, 175, 0.1)',
          borderWidth: 1.5, tension: 0.4, fill: false,
          pointRadius: 0, pointHoverRadius: 3,
          yAxisID: 'y1',
        });
      }

      const chartOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'top', 
            labels: { 
              color: '#E0E0E0', 
              font: { size: 12 }, 
              usePointStyle: true, 
              padding: 20 
            }
          },
          tooltip: {
            mode: 'index', intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.85)', 
            titleColor: config.color, 
            bodyColor: '#E0E0E0',
            borderColor: config.color + '80', 
            borderWidth: 1, 
            cornerRadius: 8,
            callbacks: { 
              label: (c) => `${c.dataset.label}: ${formatNumber(c.parsed.y)}` 
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#888', font: { size: 10 }, maxRotation: 0, minRotation: 0 },
            grid: { color: config.color + '10' }
          },
          y: {
            position: 'right',
            ticks: { 
              callback: v => '3xl font-bold ${currentPosition === 'æŒæœ‰' ? 'text-green-400' : 'text-red-500'} mb-2">${currentPosition}</p>
                <p class="text-gray-500 text-sm">ç»¼åˆæŠ€æœ¯æŒ‡æ ‡ç ”åˆ¤</p>
              </div>
              
              <div class="black-gold-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-semibold text-gray-300">ğŸ’° ${currentAsset}ä»·æ ¼</h2>
                  <span class="text-2xl" style="color: ${config.color}">ğŸ’</span>
                </div>
                <p class="text-3xl font-bold mb-2" style="color: ${config.color}">$${formatNumber(latestPrice)}</p>
                <p class="text-gray-400 text-sm flex items-center">
                  <span class="mr-2">${latestChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'}</span>24h: ${latestChange}%
                </p>
                ${config.showSecondary ? `<p class="text-gray-500 text-xs mt-1">QQQ: $${formatNumber(latestSecondaryPrice)}</p>` : ''}
              </div>
              
              <div class="black-gold-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-semibold text-gray-300">ğŸ“ˆ 20æ—¥å‡çº¿</h2>
                  <span class="text-2xl">${latestTrend === 'ä¸Šå‡' ? 'ğŸš€' : 'ğŸ“‰'}</span>
                </div>
                <p class="text-2xl font-bold text-gray-200 mb-2">$${formatNumber(latest20MA)}</p>
                <p class="text-gray-400 text-sm">è¶‹åŠ¿: ${latestTrend}</p>
                <p class="text-gray-500 text-xs">${pricePosition}</p>
                ${currentAsset === 'TQQQ' ? '<p class="text-gray-600 text-xs">åŸºäºQQQæ•°æ®</p>' : ''}
              </div>
              
              <div class="black-gold-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-semibold text-gray-300">ğŸ“Š ä¿¡å·ç»Ÿè®¡</h2>
                  <span class="text-2xl" style="color: ${config.color}">ğŸ””</span>
                </div>
                <p class="text-gray-400 text-sm mb-1">æ€»ä¿¡å·: <span class="font-bold text-gray-200">${totalSignals}</span></p>
                <p class="text-green-400 text-sm mb-1">ä¹°å…¥: <span class="font-bold">${buySignals}</span></p>
                <p class="text- + formatNumber(v), 
              color: '#888', 
              font: { size: 10 }
            },
            grid: { color: config.color + '20', borderColor: 'transparent' }
          }
        },
        interaction: { mode: 'nearest', axis: 'x', intersect: false }
      };

      // Add secondary y-axis for TQQQ
      if (currentAsset === 'TQQQ') {
        chartOptions.scales.y1 = {
          type: 'linear',
          display: false,
          position: 'left',
        };
      }

      chartInstance = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: chartData.map(r => formatDate(r.date).substring(5)),
          datasets: datasets
        },
        options: chartOptions
      });
    }

    // Auto-refresh functionality
    function startAutoRefresh() {
      // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°æ•°æ®
      const refreshInterval = 5 * 60 * 1000; // 5 minutes
      
      setInterval(async () => {
        console.log('è‡ªåŠ¨åˆ·æ–°æ•°æ®...');
        try {
          await renderDashboard();
          console.log('è‡ªåŠ¨åˆ·æ–°å®Œæˆ');
        } catch (error) {
          console.error('è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', error);
        }
      }, refreshInterval);
    }

    // Health check for APIs
    async function performHealthCheck() {
      console.log('æ‰§è¡ŒAPIå¥åº·æ£€æŸ¥...');
      
      try {
        // Test CoinGecko API
        const testUrl = 'https://api.coingecko.com/api/v3/ping';
        await fetchWithRetry(testUrl);
        
        console.log('APIå¥åº·æ£€æŸ¥é€šè¿‡');
        return true;
      } catch (error) {
        console.warn('APIå¥åº·æ£€æŸ¥å¤±è´¥:', error.message);
        return false;
      }
    }

    // Make functions globally available
    window.switchAsset = switchAsset;
    window.renderDashboard = renderDashboard;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('åˆå§‹åŒ–Unisparké‡åŒ–äº¤æ˜“å¹³å°...');
      
      // Initialize from URL parameters
      initializeFromUrl();
      
      // Perform initial health check
      await performHealthCheck();
      
      // Render initial dashboard
      await renderDashboard();
      
      // Start auto-refresh
      startAutoRefresh();
      
      // Handle browser back/forward buttons
      window.addEventListener('popstate', function(event) {
        initializeFromUrl();
        renderDashboard();
      });

      // Add keyboard shortcuts
      document.addEventListener('keydown', function(event) {
        if (event.ctrlKey || event.metaKey) {
          switch(event.key) {
            case '1':
              event.preventDefault();
              switchAsset('BTC');
              break;
            case '2':
              event.preventDefault();
              switchAsset('ETH');
              break;
            case '3':
              event.preventDefault();
              switchAsset('TQQQ');
              break;
            case 'r':
              event.preventDefault();
              renderDashboard();
              break;
          }
        }
      });

      console.log('å¹³å°åˆå§‹åŒ–å®Œæˆ');
    });

    // Handle page visibility changes to pause/resume updates
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        console.log('é¡µé¢éšè—ï¼Œæš‚åœæ›´æ–°');
      } else {
        console.log('é¡µé¢å¯è§ï¼Œæ¢å¤æ›´æ–°');
        renderDashboard();
      }
    });

    // Error handling for unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
      updateApiStatus(false);
    });

  </script>

</body>
</html>3xl font-bold ${currentPosition === 'æŒæœ‰' ? 'text-green-400' : 'text-red-500'} mb-2">${currentPosition}</p>
                <p class="text-gray-500 text-sm">ç»¼åˆæŠ€æœ¯æŒ‡æ ‡ç ”åˆ¤</p>
              </div>
              
              <div class="black-gold-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-semibold text-gray-300">ğŸ’° ${currentAsset}ä»·æ ¼</h2>
                  <span class="text-2xl" style="color: ${config.color}">ğŸ’</span>
                </div>
                <p class="text-3xl font-bold mb-2" style="color: ${config.color}">$${formatNumber(latestPrice)}</p>
                <p class="text-gray-400 text-sm flex items-center">
                  <span class="mr-2">${latestChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'}</span>24h: ${latestChange}%
                </p>
                ${config.showSecondary ? `<p class="text-gray-500 text-xs mt-1">QQQ: $${formatNumber(latestSecondaryPrice)}</p>` : ''}
              </div>
              
              <div class="black-gold-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-semibold text-gray-300">ğŸ“ˆ 20æ—¥å‡çº¿</h2>
                  <span class="text-2xl">${latestTrend === 'ä¸Šå‡' ? 'ğŸš€' : 'ğŸ“‰'}</span>
                </div>
                <p class="text-2xl font-bold text-gray-200 mb-2">$${formatNumber(latest20MA)}</p>
                <p class="text-gray-400 text-sm">è¶‹åŠ¿: ${latestTrend}</p>
                <p class="text-gray-500 text-xs">${pricePosition}</p>
                ${currentAsset === 'TQQQ' ? '<p class="text-gray-600 text-xs">åŸºäºQQQæ•°æ®</p>' : ''}
              </div>
              
              <div class="black-gold-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-semibold text-gray-300">ğŸ“Š ä¿¡å·ç»Ÿè®¡</h2>
                  <span class="text-2xl" style="color: ${config.color}">ğŸ””</span>
                </div>
                <p class="text-gray-400 text-sm mb-1">æ€»ä¿¡å·: <span class="font-bold text-gray-200">${totalSignals}</span></p>
                <p class="text-green-400 text-sm mb-1">ä¹°å…¥: <span class="font-bold">${buySignals}</span></p>
                <p class="text-
