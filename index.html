<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unispark é‡åŒ–äº¤æ˜“å¹³å° - ä¸“ä¸šçº§åŠ å¯†è´§å¸ä¸è‚¡ç¥¨é‡åŒ–åˆ†æ</title>
  <meta name="description" content="åŸºäº20æ—¥å‡çº¿çš„ä¸“ä¸šé‡åŒ–äº¤æ˜“å¹³å°ï¼Œæ”¯æŒBTCã€ETHã€TQQQå®æ—¶åˆ†æä¸äº¤æ˜“ä¿¡å·">
  <meta name="keywords" content="é‡åŒ–äº¤æ˜“,BTC,ETH,TQQQ,æŠ€æœ¯åˆ†æ,äº¤æ˜“ä¿¡å·,åŠ å¯†è´§å¸">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eâ‚¿%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    
    :root {
      --primary-gold: #FFD700;
      --secondary-gold: #F0E68C;
      --dark-gold: #B8860B;
      --eth-blue: #627EEA;
      --tqqq-green: #00D4AA;
      --bg-primary: #0a0a0a;
      --bg-secondary: rgba(10, 10, 10, 0.7);
      --text-primary: #E0E0E0;
      --text-secondary: #888;
      --border-primary: rgba(212, 175, 55, 0.3);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      background-image: 
        radial-gradient(ellipse at top, rgba(38, 32, 20, 0.4) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, rgba(20, 25, 35, 0.3) 0%, transparent 50%),
        linear-gradient(135deg, rgba(255, 215, 0, 0.02) 0%, rgba(99, 126, 234, 0.02) 50%, rgba(0, 212, 170, 0.02) 100%);
      min-height: 100vh;
      color: var(--text-primary);
      overflow-x: hidden;
      font-feature-settings: 'kern' 1, 'liga' 1;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .glass-card {
      background: var(--bg-secondary);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--border-primary);
      box-shadow: 
        0 8px 32px rgba(212, 175, 55, 0.1),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset,
        0 2px 16px rgba(0, 0, 0, 0.3);
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
    }
    
    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .glass-card:hover {
      transform: translateY(-8px) scale(1.01);
      border-color: rgba(255, 215, 0, 0.6);
      box-shadow: 
        0 20px 60px rgba(212, 175, 55, 0.2),
        0 0 0 1px rgba(255, 215, 0, 0.1) inset,
        0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    .glass-card:hover::before {
      opacity: 1;
    }

    .gradient-text {
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% 200%;
      animation: gradient-shift 3s ease-in-out infinite;
    }
    
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .status-indicator {
      position: relative;
      overflow: hidden;
    }
    
    .status-indicator::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      border-radius: 50%;
      background: inherit;
      animation: pulse-glow 2s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes pulse-glow {
      0%, 100% { 
        transform: scale(0.8);
        opacity: 0.3;
      }
      50% { 
        transform: scale(1.2);
        opacity: 0.1;
      }
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid rgba(255, 215, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-gold);
      animation: spin 1s linear infinite;
      position: relative;
    }
    
    .loading-spinner::after {
      content: '';
      position: absolute;
      top: 6px;
      left: 6px;
      width: 44px;
      height: 44px;
      border: 2px solid transparent;
      border-radius: 50%;
      border-top-color: rgba(255, 215, 0, 0.3);
      animation: spin 2s linear infinite reverse;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .asset-tab {
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .asset-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-gold), var(--secondary-gold));
      transition: width 0.3s ease;
    }

    .asset-tab.active::after {
      width: 100%;
    }

    .asset-tab.active {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
    }

    .asset-tab:not(.active):hover {
      transform: translateY(-2px);
      background: rgba(255, 215, 0, 0.08);
      border-color: rgba(255, 215, 0, 0.4);
    }
    
    .metric-card {
      position: relative;
      overflow: hidden;
    }
    
    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.04), transparent);
      transition: left 0.5s ease;
    }
    
    .metric-card:hover::before {
      left: 100%;
    }
    
    .chart-container {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }
    
    .signal-item {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .signal-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 3px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary-gold), transparent);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }
    
    .signal-item:hover::before {
      transform: scaleY(1);
    }
    
    .signal-item:hover {
      transform: translateX(8px);
      background: rgba(255, 255, 255, 0.05);
    }
    
    .performance-indicator {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .performance-positive {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(21, 128, 61, 0.1));
      color: #10b981;
      border-color: rgba(34, 197, 94, 0.3);
    }
    
    .performance-negative {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(185, 28, 28, 0.1));
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    
    .tooltip:hover::after {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .asset-tab {
        padding: 12px 16px;
      }
      
      .glass-card {
        padding: 16px;
      }
      
      .chart-container {
        padding: 12px;
      }
    }
    
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease-out forwards;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .slide-up {
      animation: slideUp 0.8s ease-out forwards;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>

  <div id="root" class="max-w-7xl mx-auto p-4 md:p-6">
    <div class="glass-card rounded-3xl p-8 text-center">
      <div class="loading-spinner mx-auto mb-6"></div>
      <h2 class="text-2xl font-bold text-gray-200 mb-2">æ­£åœ¨åˆå§‹åŒ–é‡åŒ–ç³»ç»Ÿ...</h2>
      <p class="text-gray-400">è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨åŠ è½½æ ¸å¿ƒæ¨¡å—</p>
    </div>
  </div>

  <script>
    'use strict';
    
    // Global state management
    class QuantState {
      constructor() {
        this.currentAsset = 'BTC';
        this.chartInstance = null;
        this.refreshInterval = null;
        this.isLoading = false;
        this.retryCount = 0;
        this.maxRetries = 3;
      }
      
      setAsset(asset) {
        if (this.currentAsset !== asset && this.assetConfigs[asset]) {
          this.currentAsset = asset;
          this.updateUrl(asset);
          return true;
        }
        return false;
      }
      
      updateUrl(asset) {
        const url = new URL(window.location);
        url.searchParams.set('asset', asset);
        window.history.pushState({}, '', url);
      }
      
      destroyChart() {
        if (this.chartInstance) {
          this.chartInstance.destroy();
          this.chartInstance = null;
        }
      }
      
      // Asset configurations with enhanced metadata
      assetConfigs = {
        BTC: {
          name: 'Bitcoin',
          fullName: 'æ¯”ç‰¹å¸',
          symbol: 'â‚¿',
          apiSymbol: 'BTCUSD',
          color: '#FFD700',
          gradientColors: ['#FFD700', '#F0E68C', '#B8860B'],
          showSecondary: false,
          category: 'cryptocurrency',
          volatility: 'high',
          marketCap: 'large',
          description: 'å…¨çƒæœ€å¤§çš„åŠ å¯†è´§å¸'
        },
        ETH: {
          name: 'Ethereum',
          fullName: 'ä»¥å¤ªåŠ',
          symbol: 'Î',
          apiSymbol: 'ETHUSD',
          color: '#627EEA',
          gradientColors: ['#627EEA', '#8FA8F5', '#4A69D6'],
          showSecondary: false,
          category: 'cryptocurrency',
          volatility: 'high',
          marketCap: 'large',
          description: 'æ™ºèƒ½åˆçº¦å¹³å°é¾™å¤´'
        },
        TQQQ: {
          name: 'ProShares UltraPro QQQ',
          fullName: 'çº³æ–¯è¾¾å…‹ä¸‰å€åšå¤šETF',
          symbol: 'TQQQ',
          apiSymbol: 'TQQQ',
          indicatorSymbol: 'QQQ',
          color: '#00D4AA',
          gradientColors: ['#00D4AA', '#4DEBA8', '#00B894'],
          showSecondary: true,
          secondaryName: 'NASDAQ-100 (QQQ)',
          category: 'etf',
          volatility: 'very_high',
          leverage: '3x',
          description: 'çº³æ–¯è¾¾å…‹æŒ‡æ•°ä¸‰å€æ æ†ETF'
        }
      };
    }

    const state = new QuantState();

    // Utility functions with error handling
    const utils = {
      getUrlParameter(name) {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(name);
        } catch (error) {
          console.error('Error parsing URL parameters:', error);
          return null;
        }
      },

      formatNumber(num, precision = 2) {
        if (num == null || isNaN(num)) return 'N/A';
        
        const absNum = Math.abs(num);
        if (absNum >= 1e9) return (num / 1e9).toFixed(precision) + 'B';
        if (absNum >= 1e6) return (num / 1e6).toFixed(precision) + 'M';
        if (absNum >= 1e3) return (num / 1e3).toFixed(precision) + 'K';
        
        return num.toFixed(precision);
      },

      formatDate(date, options = {}) {
        try {
          const defaultOptions = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            ...options
          };
          return date.toLocaleDateString('zh-CN', defaultOptions);
        } catch (error) {
          console.error('Error formatting date:', error);
          return 'Invalid Date';
        }
      },

      formatPercentage(value, showSign = true) {
        if (value == null || isNaN(value)) return 'N/A';
        const sign = showSign && value > 0 ? '+' : '';
        return `${sign}${value.toFixed(2)}%`;
      },

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      throttle(func, limit) {
        let inThrottle;
        return function() {
          const args = arguments;
          const context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      }
    };

    // Enhanced data generators with more realistic patterns
    const dataGenerators = {
      generateMockData(basePrice, asset) {
        console.log(`Generating enhanced mock data for ${asset}`);
        const mockData = [];
        const today = new Date();
        const volatilityMap = { BTC: 0.08, ETH: 0.10, TQQQ: 0.15 };
        const volatility = volatilityMap[asset] || 0.08;
        
        let currentPrice = basePrice;
        
        for (let i = 89; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          
          // Market cycle simulation
          const marketCycle = Math.sin(i * 0.05) * 0.3;
          const weeklyTrend = Math.sin(i * 0.02) * 0.2;
          const randomWalk = (Math.random() - 0.5) * volatility;
          
          // Weekend effect (lower volatility)
          const dayOfWeek = date.getDay();
          const weekendMultiplier = (dayOfWeek === 0 || dayOfWeek === 6) ? 0.5 : 1;
          
          const priceChange = (marketCycle + weeklyTrend + randomWalk) * weekendMultiplier;
          currentPrice *= (1 + priceChange);
          currentPrice = Math.max(currentPrice, basePrice * 0.3); // Floor protection
          
          mockData.push({ 
            date: date, 
            price: currentPrice,
            indicatorPrice: currentPrice,
            volume: Math.random() * 1000000 + 500000,
            marketCap: currentPrice * 19000000 // Approximate circulating supply
          });
        }
        
        return mockData;
      },

      generateMockTQQQData() {
        console.log("Generating enhanced TQQQ mock data");
        const mockData = [];
        const baseTQQQPrice = 70;
        const baseQQQPrice = 400;
        const today = new Date();
        
        let currentTQQQPrice = baseTQQQPrice;
        let currentQQQPrice = baseQQQPrice;
        
        for (let i = 89; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          
          // Market trends
          const marketTrend = Math.sin(i * 0.03) * 0.15;
          const volatility = (Math.random() - 0.5) * 0.08;
          
          // QQQ price movement
          const qqqChange = marketTrend + volatility;
          currentQQQPrice *= (1 + qqqChange);
          currentQQQPrice = Math.max(currentQQQPrice, baseQQQPrice * 0.5);
          
          // TQQQ follows with 3x leverage
          const tqqqChange = qqqChange * 3;
          currentTQQQPrice *= (1 + tqqqChange);
          currentTQQQPrice = Math.max(currentTQQQPrice, baseTQQQPrice * 0.2);
          
          mockData.push({ 
            date: date, 
            price: currentTQQQPrice,
            indicatorPrice: currentQQQPrice,
            secondaryPrice: currentQQQPrice,
            volume: Math.random() * 50000000 + 10000000,
            leverage: 3
          });
        }
        
        return mockData;
      }
    };

    // Enhanced technical analysis
    const technicalAnalysis = {
      calculateIndicators(data) {
        const dataWithMA = data.map((row, index, arr) => {
          let MA20 = null;
          let MA5 = null;
          let MA50 = null;
          
          // 20-day MA
          if (index >= 19) {
            const prices = arr.slice(index - 19, index + 1).map(r => r.indicatorPrice);
            if (prices.length === 20 && prices.every(p => typeof p === 'number' && !isNaN(p))) {
              MA20 = prices.reduce((sum, p) => sum + p, 0) / 20;
            }
          }
          
          // 5-day MA for short-term trend
          if (index >= 4) {
            const prices = arr.slice(index - 4, index + 1).map(r => r.indicatorPrice);
            if (prices.length === 5 && prices.every(p => typeof p === 'number' && !isNaN(p))) {
              MA5 = prices.reduce((sum, p) => sum + p, 0) / 5;
            }
          }
          
          // 50-day MA for long-term trend
          if (index >= 49) {
            const prices = arr.slice(index - 49, index + 1).map(r => r.indicatorPrice);
            if (prices.length === 50 && prices.every(p => typeof p === 'number' && !isNaN(p))) {
              MA50 = prices.reduce((sum, p) => sum + p, 0) / 50;
            }
          }
          
          return { ...row, MA20, MA5, MA50 };
        });
        
        // Calculate trends and additional indicators
        const dataWithIndicators = dataWithMA.map((row, index, arr) => {
          let MAtrend = 'æœªçŸ¥';
          let strength = 0;
          let momentum = 0;
          
          if (row.MA20 != null && index > 0) {
            const prevMA20 = arr[index - 1].MA20;
            if (prevMA20 != null) {
              MAtrend = row.MA20 > prevMA20 ? 'ä¸Šå‡' : 'ä¸‹é™';
              strength = Math.abs((row.MA20 - prevMA20) / prevMA20) * 100;
            }
          }
          
          // Price momentum (3-day change)
          if (index >= 2) {
            const pastPrice = arr[index - 2].indicatorPrice;
            momentum = ((row.indicatorPrice - pastPrice) / pastPrice) * 100;
          }
          
          // Volatility (5-day)
          let volatility = 0;
          if (index >= 4) {
            const prices = arr.slice(index - 4, index + 1).map(r => r.indicatorPrice);
            const avgPrice = prices.reduce((sum, p) => sum + p, 0) / prices.length;
            const variance = prices.reduce((sum, p) => sum + Math.pow(p - avgPrice, 2), 0) / prices.length;
            volatility = Math.sqrt(variance) / avgPrice * 100;
          }
          
          return { 
            ...row, 
            MAtrend, 
            strength, 
            momentum, 
            volatility 
          };
        });
        
        return dataWithIndicators;
      },

      generateSignals(data) {
        const dataWithSignals = data.reduce((accumulator, currentRow, index) => {
          let signal = '';
          let confidence = 0;
          const prevPosition = index > 0 ? accumulator[index - 1].POSITION : 'ç©ºä»“';
          let currentPosition = prevPosition;

          if (index >= 19 && currentRow.MA20 != null && currentRow.MAtrend !== 'æœªçŸ¥') {
            const currentPrice = parseFloat(currentRow.indicatorPrice);
            const currentMA = parseFloat(currentRow.MA20);
            const currentTrend = currentRow.MAtrend;
            const momentum = currentRow.momentum || 0;
            const strength = currentRow.strength || 0;
            
            if (currentPrice && currentMA && currentTrend) {
              const buyThreshold = currentMA * 1.01;
              const sellThreshold = currentMA * 0.99;
              
              // Enhanced buy conditions
              const condition1_buy = prevPosition === 'ç©ºä»“';
              const condition2_buy = currentTrend === 'ä¸Šå‡';
              const condition3_buy = currentPrice > buyThreshold;
              const condition4_buy = momentum > 1; // Positive momentum
              
              if (condition1_buy && condition2_buy && condition3_buy) {
                signal = 'ä¹°å…¥';
                currentPosition = 'æŒæœ‰';
                confidence = Math.min(90, 50 + strength * 2 + (momentum > 0 ? 20 : 0));
              }
              
              // Enhanced sell conditions
              const condition1_sell = prevPosition === 'æŒæœ‰';
              const condition2_sell = currentTrend === 'ä¸‹é™';
              const condition3_sell = currentPrice < sellThreshold;
              const condition4_sell = momentum < -1; // Negative momentum
              
              if (condition1_sell && condition2_sell && condition3_sell) {
                signal = 'å–å‡º';
                currentPosition = 'ç©ºä»“';
                confidence = Math.min(90, 50 + strength * 2 + (momentum < 0 ? 20 : 0));
              }
            }
          }
          
          accumulator.push({ 
            ...currentRow, 
            Signal: signal, 
            POSITION: currentPosition, 
            confidence: Math.round(confidence) 
          });
          return accumulator;
        }, []);
        
        return dataWithSignals;
      },

      calculatePerformanceMetrics(data) {
        const signals = data.filter(d => d.Signal && d.Signal !== '');
        if (signals.length < 2) return null;
        
        let totalReturn = 0;
        let winTrades = 0;
        let lossTrades = 0;
        let currentHolding = null;
        
        signals.forEach((signal, index) => {
          if (signal.Signal === 'ä¹°å…¥') {
            currentHolding = signal.price;
          } else if (signal.Signal === 'å–å‡º' && currentHolding) {
            const trade = (signal.price - currentHolding) / currentHolding;
            totalReturn += trade;
            if (trade > 0) winTrades++;
            else lossTrades++;
            currentHolding = null;
          }
        });
        
        const totalTrades = winTrades + lossTrades;
        const winRate = totalTrades > 0 ? (winTrades / totalTrades) * 100 : 0;
        
        return {
          totalReturn: totalReturn * 100,
          winRate,
          totalTrades,
          winTrades,
          lossTrades
        };
      }
    };

    // Enhanced UI components
    const ui = {
      renderAssetTabs() {
        return `
          <div class="flex justify-center mb-8">
            <div class="flex bg-gray-900 bg-opacity-30 backdrop-filter backdrop-blur-xl rounded-2xl p-3 space-x-3 border border-gray-700">
              ${Object.keys(state.assetConfigs).map(asset => {
                const config = state.assetConfigs[asset];
                const isActive = asset === state.currentAsset;
                return `
                  <div class="asset-tab glass-card rounded-xl px-6 py-4 ${isActive ? 'active' : ''}" 
                       onclick="switchAsset('${asset}')" 
                       style="border-color: ${isActive ? config.color + '80' : 'rgba(212, 175, 55, 0.3)'}">
                    <div class="flex items-center space-x-3">
                      <span class="text-2xl">${config.symbol}</span>
                      <div>
                        <div class="font-semibold text-gray-200">${asset}</div>
                        <div class="text-xs text-gray-400">${config.fullName}</div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      },

      renderLoadingState(message = 'æ­£åœ¨åŠ è½½æ•°æ®...') {
        return `
          ${this.renderAssetTabs()}
          <div class="glass-card rounded-3xl p-8 text-center fade-in">
            <div class="loading-spinner mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold text-gray-200 mb-2">${message}</h2>
            <p class="text-gray-400">è¯·ç¨å€™ï¼Œæ­£åœ¨å¤„ç† ${state.currentAsset} æ•°æ®</p>
          </div>
        `;
      },

      renderErrorState(error) {
        return `
          ${this.renderAssetTabs()}
          <div class="glass-card rounded-3xl p-8 text-center fade-in">
            <div class="text-6xl mb-4 text-red-400">âš ï¸</div>
            <h2 class="text-2xl font-bold text-gray-200 mb-4">ç³»ç»Ÿå¼‚å¸¸</h2>
            <p class="text-gray-400 mb-4">${error || 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'}</p>
            <button onclick="location.reload()" class="glass-card px-6 py-3 rounded-xl text-white hover:scale-105 transition-transform">
              é‡æ–°åŠ è½½
            </button>
          </div>
        `;
      },

      renderMetricCard(title, value, subtitle, icon, color, trend = null) {
        const trendIndicator = trend ? `
          <div class="flex items-center text-xs mt-1">
            <span class="mr-1">${trend > 0 ? 'ğŸ“ˆ' : trend < 0 ? 'ğŸ“‰' : 'â–'}</span>
            <span class="${trend > 0 ? 'text-green-400' : trend < 0 ? 'text-red-400' : 'text-gray-400'}">
              ${utils.formatPercentage(Math.abs(trend))}
            </span>
          </div>
        ` : '';

        return `
          <div class="metric-card glass-card rounded-2xl p-6 slide-up">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-300">${title}</h2>
              <span class="text-2xl" style="color: ${color}">${icon}</span>
            </div>
            <p class="text-3xl font-bold mb-2" style="color: ${color}">${value}</p>
            <p class="text-gray-500 text-sm">${subtitle}</p>
            ${trendIndicator}
          </div>
        `;
      },

      renderSignalList(signals) {
        if (!signals.length) {
          return '<div class="text-gray-500 text-center py-8">æš‚æ— è¿‘æœŸäº¤æ˜“ä¿¡å·</div>';
        }

        return signals.map(s => `
          <div class="signal-item bg-gray-900 bg-opacity-50 rounded-xl p-4 border border-gray-700 hover:border-amber-500 transition-all duration-300">
            <div class="flex justify-between items-center">
              <div class="flex flex-col">
                <span class="text-gray-400 text-sm">${utils.formatDate(s.date)}</span>
                ${s.confidence ? `<span class="text-xs text-gray-500 mt-1">ç½®ä¿¡åº¦: ${s.confidence}%</span>` : ''}
              </div>
              <div class="flex items-center space-x-3">
                <span class="performance-indicator ${s.Signal === 'ä¹°å…¥' ? 'performance-positive' : 'performance-negative'}">
                  ${s.Signal}
                </span>
                <span class="font-mono text-gray-200 font-bold">${utils.formatNumber(s.price)}</span>
              </div>
            </div>
          </div>
        `).join('');
      },

      renderPerformancePanel(performance) {
        if (!performance) return '';

        return `
          <div class="glass-card rounded-2xl p-6 slide-up">
            <h2 class="text-xl font-semibold text-gray-200 mb-6 flex items-center">
              <span class="mr-3 text-amber-400">ğŸ“Š</span>ç­–ç•¥è¡¨ç°
            </h2>
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold ${performance.totalReturn >= 0 ? 'text-green-400' : 'text-red-400'}">
                  ${utils.formatPercentage(performance.totalReturn)}
                </div>
                <div class="text-sm text-gray-400">ç´¯è®¡æ”¶ç›Š</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-400">${performance.winRate.toFixed(1)}%</div>
                <div class="text-sm text-gray-400">èƒœç‡</div>
              </div>
              <div class="text-center">
                <div class="text-xl font-semibold text-gray-300">${performance.totalTrades}</div>
                <div class="text-sm text-gray-400">æ€»äº¤æ˜“æ¬¡æ•°</div>
              </div>
              <div class="text-center">
                <div class="text-xl font-semibold text-gray-300">${performance.winTrades}/${performance.lossTrades}</div>
                <div class="text-sm text-gray-400">ç›ˆ/äºæ¬¡æ•°</div>
              </div>
            </div>
          </div>
        `;
      }
    };

    // Enhanced chart rendering
    const chartRenderer = {
      render(dataWithSignals, config) {
        state.destroyChart();

        const ctx = document.getElementById('chart');
        if (!ctx) return;
        
        const chartData = dataWithSignals.slice(-60);

        const datasets = [
          {
            label: `${state.currentAsset}ä»·æ ¼`,
            data: chartData.map(r => r.price),
            borderColor: config.color,
            backgroundColor: config.color + '15',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHitRadius: 10,
            pointHoverBackgroundColor: config.color,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2,
          },
          {
            label: '20æ—¥å‡çº¿',
            data: chartData.map(r => r.MA20),
            borderColor: '#E0E0E0',
            borderWidth: 2,
            borderDash: [8, 4],
            tension: 0.4,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 4,
          },
          {
            label: 'ä¹°å…¥ä¿¡å·',
            data: chartData.map(r => r.Signal === 'ä¹°å…¥' ? r.price : null),
            pointStyle: 'triangle',
            rotation: 0,
            backgroundColor: '#22c55e',
            borderColor: '#fff',
            borderWidth: 2,
            pointRadius: 10,
            pointHoverRadius: 12,
            showLine: false,
          },
          {
            label: 'å–å‡ºä¿¡å·',
            data: chartData.map(r => r.Signal === 'å–å‡º' ? r.price : null),
            pointStyle: 'triangle',
            rotation: 180,
            backgroundColor: '#ef4444',
            borderColor: '#fff',
            borderWidth: 2,
            pointRadius: 10,
            pointHoverRadius: 12,
            showLine: false,
          }
        ];

        // Add secondary price line for TQQQ
        if (state.currentAsset === 'TQQQ') {
          datasets.splice(1, 0, {
            label: 'QQQä»·æ ¼',
            data: chartData.map(r => r.secondaryPrice),
            borderColor: '#9CA3AF',
            backgroundColor: 'rgba(156, 163, 175, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 4,
            yAxisID: 'y1',
          });
        }

        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#E0E0E0',
                font: { size: 12, weight: '500' },
                usePointStyle: true,
                padding: 24,
                boxWidth: 12,
                boxHeight: 12,
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: config.color,
              bodyColor: '#E0E0E0',
              borderColor: config.color + '80',
              borderWidth: 1,
              cornerRadius: 12,
              padding: 16,
              displayColors: true,
              callbacks: {
                title: (context) => utils.formatDate(new Date(chartData[context[0].dataIndex].date)),
                label: (context) => {
                  const value = context.parsed.y;
                  if (value === null) return null;
                  return `${context.dataset.label}: ${utils.formatNumber(value)}`;
                },
                afterBody: (context) => {
                  const dataPoint = chartData[context[0].dataIndex];
                  if (dataPoint.confidence) {
                    return [`ç½®ä¿¡åº¦: ${dataPoint.confidence}%`];
                  }
                  return [];
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#888',
                font: { size: 11 },
                maxRotation: 0,
                minRotation: 0,
                maxTicksLimit: 12,
              },
              grid: {
                color: config.color + '08',
                drawBorder: false,
              }
            },
            y: {
              position: 'right',
              ticks: {
                callback: v => ' + utils.formatNumber(v),
                color: '#888',
                font: { size: 11 },
                padding: 8,
              },
              grid: {
                color: config.color + '12',
                drawBorder: false,
              }
            }
          },
          elements: {
            point: {
              hoverBorderWidth: 3,
            }
          }
        };

        // Add secondary y-axis for TQQQ
        if (state.currentAsset === 'TQQQ') {
          chartOptions.scales.y1 = {
            type: 'linear',
            display: false,
            position: 'left',
          };
        }

        state.chartInstance = new Chart(ctx.getContext('2d'), {
          type: 'line',
          data: {
            labels: chartData.map(r => utils.formatDate(r.date).substring(5)),
            datasets: datasets
          },
          options: chartOptions
        });
      }
    };

    // Main application logic
    class QuantApp {
      constructor() {
        this.init();
      }

      init() {
        this.initializeFromUrl();
        this.setupEventListeners();
        this.renderDashboard();
        this.setupAutoRefresh();
      }

      initializeFromUrl() {
        const urlAsset = utils.getUrlParameter('asset');
        if (urlAsset && state.assetConfigs[urlAsset.toUpperCase()]) {
          state.currentAsset = urlAsset.toUpperCase();
        }
      }

      setupEventListeners() {
        // Handle browser navigation
        window.addEventListener('popstate', () => {
          this.initializeFromUrl();
          this.renderDashboard();
        });

        // Handle visibility change for performance
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            this.pauseAutoRefresh();
          } else {
            this.resumeAutoRefresh();
          }
        });

        // Handle network status
        window.addEventListener('online', () => {
          console.log('Network reconnected');
          this.renderDashboard();
        });

        window.addEventListener('offline', () => {
          console.log('Network disconnected');
        });
      }

      setupAutoRefresh() {
        // Clear existing interval
        if (state.refreshInterval) {
          clearInterval(state.refreshInterval);
        }

        // Set up new interval (5 minutes)
        state.refreshInterval = setInterval(() => {
          if (!document.hidden && !state.isLoading) {
            this.renderDashboard();
          }
        }, 5 * 60 * 1000);
      }

      pauseAutoRefresh() {
        if (state.refreshInterval) {
          clearInterval(state.refreshInterval);
          state.refreshInterval = null;
        }
      }

      resumeAutoRefresh() {
        if (!state.refreshInterval) {
          this.setupAutoRefresh();
        }
      }

      async loadAssetData(asset) {
        console.log(`Loading enhanced data for ${asset}`);
        
        // Simulate network delay for realism
        await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
        
        if (asset === 'TQQQ') {
          return dataGenerators.generateMockTQQQData();
        } else if (asset === 'BTC') {
          return dataGenerators.generateMockData(65000, asset);
        } else if (asset === 'ETH') {
          return dataGenerators.generateMockData(3500, asset);
        }
        
        return dataGenerators.generateMockData(50000, asset);
      }

      async renderDashboard() {
        if (state.isLoading) return;
        
        state.isLoading = true;
        const root = document.getElementById('root');
        const config = state.assetConfigs[state.currentAsset];
        
        try {
          // Show loading state
          root.innerHTML = ui.renderLoadingState();

          const rawData = await this.loadAssetData(state.currentAsset);
          
          if (rawData.length < 20) {
            root.innerHTML = ui.renderErrorState(`æ•°æ®ä¸è¶³ï¼šéœ€è¦è‡³å°‘20å¤©æ•°æ®ï¼Œå½“å‰ä»…æœ‰${rawData.length}å¤©`);
            return;
          }

          const dataWithMA = technicalAnalysis.calculateIndicators(rawData);
          const dataWithSignals = technicalAnalysis.generateSignals(dataWithMA);
          const performance = technicalAnalysis.calculatePerformanceMetrics(dataWithSignals);

          // Calculate metrics
          const latest = dataWithSignals[dataWithSignals.length - 1] || {};
          const previous = dataWithSignals[dataWithSignals.length - 2] || {};
          
          const metrics = {
            currentPosition: latest.POSITION || 'æœªçŸ¥',
            latestPrice: latest.price || 0,
            latestSecondaryPrice: latest.secondaryPrice || 0,
            priceChange: previous.price ? ((latest.price - previous.price) / previous.price * 100) : 0,
            latest20MA: latest.MA20,
            latestTrend: latest.MAtrend || 'æœªçŸ¥',
            volatility: latest.volatility || 0,
            momentum: latest.momentum || 0,
            confidence: latest.confidence || 0
          };

          const pricePosition = (latest.indicatorPrice != null && latest.MA20 != null && latest.MA20 !== 0) 
            ? (latest.indicatorPrice > latest.MA20 ? 'é«˜äº20æ—¥å‡çº¿' : 'ä½äº20æ—¥å‡çº¿') : 'æœªçŸ¥';

          const recentSignals = dataWithSignals.filter(r => r.Signal && r.Signal !== '').slice(-5).reverse();
          const signalStats = {
            total: dataWithSignals.filter(r => r.Signal && r.Signal !== '').length,
            buy: dataWithSignals.filter(r => r.Signal === 'ä¹°å…¥').length,
            sell: dataWithSignals.filter(r => r.Signal === 'å–å‡º').length
          };

          // Generate gradient CSS
          const gradientText = `background: linear-gradient(135deg, ${config.gradientColors[0]} 20%, ${config.gradientColors[1]} 50%, ${config.gradientColors[2]} 90%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;`;

          root.innerHTML = `
            ${ui.renderAssetTabs()}
            <div class="glass-card rounded-3xl p-6 md:p-8 mb-6 fade-in">
              <!-- Header Section -->
              <div class="text-center mb-12">
                <h1 class="text-4xl md:text-6xl font-black mb-4 flex items-center justify-center tracking-tight gradient-text" style="${gradientText}">
                  <span class="text-5xl md:text-7xl mr-4 opacity-90">${config.symbol}</span>
                  ${state.currentAsset} Unispark é‡åŒ–
                  <div class="status-indicator relative ml-6 mt-2">
                    <div class="w-4 h-4 rounded-full" style="background-color: ${config.color}"></div>
                  </div>
                </h1>
                <p class="text-gray-400 text-lg mb-2">åŸºäº20æ—¥å‡çº¿çš„ä¸“ä¸šçº§äº¤æ˜“ä¿¡å·åˆ†æç³»ç»Ÿ</p>
                <p class="text-gray-500 text-sm">${config.description}</p>
                ${state.currentAsset === 'TQQQ' ? '<div class="mt-4 inline-flex items-center px-4 py-2 bg-amber-500 bg-opacity-20 rounded-full border border-amber-500 border-opacity-30"><span class="text-amber-400 text-sm font-medium">âš ï¸ äº¤æ˜“æ ‡çš„ï¼šTQQQ | æŒ‡æ ‡åŸºå‡†ï¼šQQQ | 3å€æ æ†</span></div>' : ''}
              </div>

              <!-- Metrics Grid -->
              <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                ${ui.renderMetricCard(
                  'ğŸ¯ äº¤æ˜“å»ºè®®', 
                  metrics.currentPosition,
                  `ç½®ä¿¡åº¦: ${metrics.confidence}%`,
                  metrics.currentPosition === 'æŒæœ‰' ? 'ğŸŸ¢' : 'ğŸ”´',
                  metrics.currentPosition === 'æŒæœ‰' ? '#22c55e' : '#ef4444'
                )}
                
                ${ui.renderMetricCard(
                  `ğŸ’° ${state.currentAsset}ä»·æ ¼`,
                  `${utils.formatNumber(metrics.latestPrice)}`,
                  `24h: ${utils.formatPercentage(metrics.priceChange)}${config.showSecondary ? ` | QQQ: ${utils.formatNumber(metrics.latestSecondaryPrice)}` : ''}`,
                  'ğŸ’',
                  config.color,
                  metrics.priceChange
                )}
                
                ${ui.renderMetricCard(
                  'ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡',
                  `${utils.formatNumber(metrics.latest20MA)}`,
                  `è¶‹åŠ¿: ${metrics.latestTrend} | ${pricePosition}${state.currentAsset === 'TQQQ' ? ' (åŸºäºQQQ)' : ''}`,
                  metrics.latestTrend === 'ä¸Šå‡' ? 'ğŸš€' : 'ğŸ“‰',
                  '#E0E0E0'
                )}
                
                ${ui.renderMetricCard(
                  'ğŸ“Š ä¿¡å·ç»Ÿè®¡',
                  signalStats.total.toString(),
                  `ä¹°å…¥: ${signalStats.buy} | å–å‡º: ${signalStats.sell}`,
                  'ğŸ””',
                  config.color
                )}
              </div>

              <!-- Main Content Grid -->
              <div class="grid lg:grid-cols-5 gap-6 mb-8">
                <!-- Chart Section -->
                <div class="lg:col-span-3 glass-card rounded-2xl p-6 slide-up">
                  <h2 class="text-xl font-semibold text-gray-200 mb-6 flex items-center">
                    <span class="mr-3" style="color: ${config.color}">ğŸ“ˆ</span>ä»·æ ¼èµ°åŠ¿åˆ†æ
                    <div class="ml-auto flex items-center space-x-4 text-sm text-gray-400">
                      <div class="tooltip" data-tooltip="æ³¢åŠ¨ç‡: ${metrics.volatility.toFixed(2)}%">
                        <span>ğŸ“Š æ³¢åŠ¨: ${metrics.volatility.toFixed(1)}%</span>
                      </div>
                      <div class="tooltip" data-tooltip="ä»·æ ¼åŠ¨é‡æŒ‡æ ‡">
                        <span>âš¡ åŠ¨é‡: ${utils.formatPercentage(metrics.momentum)}</span>
                      </div>
                    </div>
                  </h2>
                  <div class="chart-container">
                    <canvas id="chart" height="140"></canvas>
                  </div>
                </div>
                
                <!-- Signals & Performance Section -->
                <div class="lg:col-span-2 space-y-6">
                  <!-- Recent Signals -->
                  <div class="glass-card rounded-2xl p-6 slide-up">
                    <h2 class="text-xl font-semibold text-gray-200 mb-6 flex items-center">
                      <span class="mr-3" style="color: ${config.color}">ğŸ”</span>æœ€è¿‘äº¤æ˜“ä¿¡å·
                    </h2>
                    <div class="space-y-3 max-h-80 overflow-y-auto">
                      ${ui.renderSignalList(recentSignals)}
                    </div>
                  </div>
                  
                  <!-- Performance Metrics -->
                  ${ui.renderPerformancePanel(performance)}
                </div>
              </div>
              
              <!-- Footer -->
              <div class="text-center mt-12 pt-8 border-t border-gray-700 border-opacity-50">
                <div class="flex flex-col md:flex-row justify-center items-center space-y-2 md:space-y-0 md:space-x-8">
                  <p class="text-gray-500 text-sm flex items-center">
                    <span class="mr-2">âš ï¸</span>æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…
                  </p>
                  <p class="text-gray-600 text-xs flex items-center">
                    <span class="mr-2">ğŸ•’</span>æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}
                  </p>
                  <p class="text-gray-600 text-xs flex items-center">
                    <span class="mr-2">ğŸ“¡</span>æ•°æ®æ¥æº: æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®
                  </p>
                </div>
              </div>
            </div>
          `;

          // Render chart after DOM update
          setTimeout(() => {
            chartRenderer.render(dataWithSignals, config);
          }, 100);

          state.retryCount = 0; // Reset retry count on success

        } catch (error) {
          console.error('Error rendering dashboard:', error);
          
          if (state.retryCount < state.maxRetries) {
            state.retryCount++;
            setTimeout(() => this.renderDashboard(), 2000 * state.retryCount);
          } else {
            root.innerHTML = ui.renderErrorState('ç³»ç»Ÿé‡åˆ°å¤šæ¬¡é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          }
        } finally {
          state.isLoading = false;
        }
      }
    }

    // Global functions
    window.switchAsset = function(asset) {
      if (state.setAsset(asset)) {
        app.renderDashboard();
      }
    };

    // Initialize application
    let app;
    document.addEventListener('DOMContentLoaded', () => {
      app = new QuantApp();
    });

    // Handle page unload
    window.addEventListener('beforeunload', () => {
      if (state.refreshInterval) {
        clearInterval(state.refreshInterval);
      }
      state.destroyChart();
    });

    // Service Worker registration for offline support (optional)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Uncomment to enable service worker
        // navigator.serviceWorker.register('/sw.js')
        //   .then(registration => console.log('SW registered'))
        //   .catch(registrationError => console.log('SW registration failed'));
      });
    }
  </script>

</body>
</html>
